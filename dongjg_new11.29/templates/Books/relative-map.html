<!DOCTYPE html> {% load static %}
<html>

<head>
    <title>人才关系图</title>
    <script src="{%static '../static/js/jquery.js'%}"></script>
    <script src="{%static '../static/js/echarts.min.js'%}"></script>
    <style>
    *{
        margin:0;
        padding:0;
    }
    </style>
</head>
    
<body>
    <!--input type="name" id="myinput">
    <button onclick="return check_search()">搜索</button-->
     
    <div id="main" target="_black" style="width:750px;height:530px;"></div>

</body>
<script type="text/javascript">

        function oneValue() {
            var result;
            var url = decodeURI(window.location.search); //获取url中"?"符后的字串  
            if (url.indexOf("?") != -1) {
                result = url.substr(url.indexOf("=") + 1);
            }
            return result;
        };
       
    check_search();
    var myInput = []
    function check_search() {
    
            if (!window.localStorage) {
                alert("浏览器不支持localStorage");
            } else {
             
              
       
                // 读取搜索
                myInput = oneValue();
       


                var ach_name= (function() {
                    var achData = []
                    $.ajax({
                        type: "get",
                        async: false, //同步执行
                        url: "http://119.29.130.157:8000/AchMultisearch/?ach_name=" + myInput,
                        dataType: "json", //返回数据形式为json
                        success: function(result) {
                            //后台返回的数据格式如下：
                
                            if(result.features.length>5){
                                achData = result.features.splice(0,10);
                            }
                            console.log('----',achData);

                        },
                        error: function(errorMsg) {
                            alert("加载失败！");
                        }
                    });
                    return achData;
                })()

                var ach_introduction = (function() {
                    var achData = []
                    $.ajax({
                        type: "get",
                        async: false, //同步执行
                        url: "http://119.29.130.157:8000/AchMultisearch/?ach_introduction=" + myInput,
                        dataType: "json", //返回数据形式为json
                        success: function(result) {
                            //后台返回的数据格式如下：
                        
                            if(result.features.length>5){
                                achData = result.features.splice(0,10);
                            }
                            console.log('----',achData);
                        },
                        error: function(errorMsg) {
                            alert("加载失败！");
                        }
                    });
                    return achData;
                })()

                var ach_people = (function() {
                    var achData = []
                    $.ajax({
                        type: "get",
                        async: false, //同步执行
                        url: "http://119.29.130.157:8000/AchMultisearch/?ach_people=" + myInput,
                        dataType: "json", //返回数据形式为json
                        success: function(result) {
                            //后台返回的数据格式如下：
                         
                            if(result.features.length>5){
                                achData = result.features.splice(0,10);
                            }
                            console.log('----',achData);
                        },
                        error: function(errorMsg) {
                            alert("加载失败！");
                        }
                    });
                    return achData;
                })()


                // var companyName = (function() {
                //     var achData = []
                //     $.ajax({
                //         type: "get",
                //         async: false, //同步执行
                //         url: "http://1.14.31.117:8000/ComMultisearch/?company_name=" + myInput,
                //         dataType: "json", //返回数据形式为json
                //         success: function(result) {
                //             //后台返回的数据格式如下：
                //             achData = result
                //             console.log('------',achData)

                //         },
                //         error: function(errorMsg) {
                //             alert("加载失败！");
                //         }
                //     });
                //     return achData;
                // })()

                // var companyintroduction= (function() {
                //     var achData = []
                //     $.ajax({
                //         type: "get",
                //         async: false, //同步执行
                //         url: "http://1.14.31.117:8000/ComMultisearch/?company_introduction=" + myInput,
                //         dataType: "json", //返回数据形式为json
                //         success: function(result) {
                //             //后台返回的数据格式如下：
                //             achData = result
                          

                //         },
                //         error: function(errorMsg) {
                //             alert("加载失败！");
                //         }
                //     });
                //     return achData;
                // })()
                // var ach_name= (function() {
                //     var achData = []
                //     $.ajax({
                //         type: "get",
                //         async: false, //同步执行
                //         url: "http://1.14.31.117:8000/AchMultisearch/?ach_name=" + myInput,
                //         dataType: "json", //返回数据形式为json
                //         success: function(result) {
                //             //后台返回的数据格式如下：
                //             achData = result
                           
                //         },
                //         error: function(errorMsg) {
                //             alert("加载失败！");
                //         }
                //     });
                //     return achData;
                // })()
                // var ach_introduction= (function() {
                //     var achData = []
                //     $.ajax({
                //         type: "get",
                //         async: false, //同步执行
                //         url: "http://1.14.31.117:8000/AchMultisearch/?ach_introduction=" + myInput,
                //         dataType: "json", //返回数据形式为json
                //         success: function(result) {
                //             //后台返回的数据格式如下：
                //             achData = result
                           
                //         },
                //         error: function(errorMsg) {
                //             alert("加载失败！");
                //         }
                //     });
                //     return achData;
                // })()
                // var ach_people= (function() {
                //     var achData = []
                //     $.ajax({
                //         type: "get",
                //         async: false, //同步执行
                //         url: "http://1.14.31.117:8000/AchMultisearch/?ach_people=" + myInput,
                //         dataType: "json", //返回数据形式为json
                //         success: function(result) {
                //             //后台返回的数据格式如下：
                //             achData = result
                           
                //         },
                //         error: function(errorMsg) {
                //             alert("加载失败！");
                //         }
                //     });
                //     return achData;
                // })()
              var achData = [];
              achData= achData.concat(ach_name).concat(ach_introduction).concat(ach_people)
              console.log('****',achData);
                //一级--二级
                var readnodeData = []
                var associatedData = []
                var readassociatedData = []
                var nodeData1 = {
                    name: myInput,
                    des: myInput,
                    symbolSize: 50,
                    category: 0,
                }
                readnodeData.push(nodeData1)

                for (var i = 0; i < achData.length; i++) {
                        var nodeData2 = {
                            name: achData[i].ach_name,
                            des: achData[i].ach_name,
                            symbolSize: 50,                          
                              category: 1,                          
                        }
                        readnodeData.push(nodeData2)
                        var associatedData = {
                            source: myInput,
                            target: achData[i].ach_name,
                           // name: '关系强度值' + achData[i].value1,
                           // des: '关系强度值' + achData[i].value1
                            name: '相关成果' ,
                            des: '相关成果'
                        }
                  
                        readassociatedData.push(associatedData)
                    //5
                    //  else if(parseInt(achData[i].value) == 5 ){

                      

                    //     var nodeData2 = {
                    //         name: achData[i].name2,
                    //         des: achData[i].name2,
                    //         symbolSize: 50,
                            
                    //           category: 2,
                         
                     
                          
                    //     }
                    //     readnodeData.push(nodeData2)
                    //     var associatedData = {
                    //         source: achData[i].name1,
                    //         target: achData[i].name2,
                    //         //name: '关系强度值' + achData[i].value1,
                    //         //des: '关系强度值' + achData[i].value1
                    //         name: '二级关系' ,
                    //         des: '二级关系',
                         
                            
                    //     }
                    //     readassociatedData.push(associatedData)
                        
                    // }
                    
                
              
                    


                }


                //去重
                for (i = 0; i < readnodeData.length; i++) {
                    for (j = i + 1; j < readnodeData.length; j++) {
                        if (readnodeData[i].name == readnodeData[j].name) {
                            readnodeData.splice(j, 1);
                            readassociatedData.splice(j - 1, 1);
                            readnodeData.length--;
                            j--;
                        }
                    }
                }
          

                console.log(readnodeData)
                console.log(readassociatedData)

                var myChart = echarts.init(document.getElementById('main'));
                var categories = [{
                    name: '关键词'
                }, {
                    name: '相关成果'
                }
                ]
         

                //
               let option = {
                    // 图的标题
                    // title: {
                    //     text: oneValue()+'关系图'
                        
                    // },
                    // 提示框的配置
                    tooltip: {
                        show:true,
                        //triggerOn:"onclick",
                        //triggerOn:"onmouseout"
                        extraCssText:"width:300px;text-align:left;display:block;white-space: normal; word-break: break-all;",
                        formatter: function(x) {
                  
                                     $.ajax({
                                            type: "get",
                                            async: false, //同步执行
                                            url: "http://119.29.130.157:8000/AchMultisearch/?ach_name="+x.data.des,
                                            dataType: "json", //返回数据形式为json
                                            success: function(result) {
                                                //后台返回的数据格式如下：
                                                achData = result
                                        
                                                console.log(achData)
                                              
                                            },
                                            error: function(errorMsg) {
                                                alert("加载失败！");
                                            }
                                        });
                        
                              return "成果名称:"+achData.features["0"].ach_name+'<br>'+
                                      "成果完成人:"+achData.features["0"].ach_people+'<br>'+
                                      "完成单位:"+achData.features["0"].ach_unit+'<br>'+
                                      "成果类别:"+achData.features["0"].ach_categary+'<br>'+
                                      "成果水平:"+achData.features["0"].ach_level+'<br>'+
                                      "成果简介:"+achData.features["0"].ach_introduction;
                                   
                                
                        }
                       
                    },
                    // 工具箱
                    toolbox: {
                        // 显示工具箱
                        show: true,
                        feature: {
                            mark: {
                                show: true
                            },
                            // 还原
                            // restore: {
                            //     show: true
                            // },
                            // // 保存为图片
                            // saveAsImage: {
                            //     show: true
                            // }
                        }
                    },
                    legend: [{
                        // selectedMode: 'single',
                        data: categories.map(function(a) {
                            return a.name;
                        })
                    }],
                        
                    series: [{
                        type: 'graph',
                        //type: 'line', // 类型:关系图
                       layout: 'force', //图的布局，类型为力导图
                       symbolSize: 10, // 调整节点的大小
                        roam: true, // 是否开启鼠标缩放和平移漫游。默认不开启。如果只想要开启缩放或者平移,可以设置成 'scale' 或者 'move'。设置成 true 为都开启
                        edgeSymbol: ['circle', 'arrow'],
                        edgeSymbolSize: [2, 10],
                        //draggable : true,
                     
                        edgeLabel: {
                            normal: {
                                textStyle: {
                                    fontSize: 20
                                }
                            }
                        },
                       
                       force: {
                           //initLayout:true,
                            repulsion: 800,
                         
                            edgeLength :200,

                         
                           
                            gravity: 0.1, //引力
             
                           
                            layoutAnimation : true,
                        },
                   
                       draggable: false,

                        lineStyle: {
                          

                            
                            normal: {
                                width: 2,
                                //color: '#4b565b',
                           
                                color: '#4b565b',
                             
                            }
                            
                        },
                        edgeLabel: {
                            normal: {
                                show: true,
                                formatter: function(x) {
                                    return x.data.name;
                                },
                                fontSize:18,
                               
                            }
                        },
                        label: {
                            normal: {
                                show: true,
                                textStyle: {
                                  
                                }
                            }
                        },
                       
                        // 数据
                        data: readnodeData,
                        links: readassociatedData,
                        categories: categories,
                    }]
                    
                };
                
                myChart.setOption(option);
                
                };




         
       

            return true;
            
            
             function  edgeLength_function(achData){
               for (i = 0; i < readnodeData.length; i++) {
                   if(achData[i].value1 == "5"){
                       return 5.0;
                     
                   }
                   else if(achData[i].value1 == "10"){
                       return 100;
                   }
               }
           }
        
      
            
       
    }
</script>

</html>